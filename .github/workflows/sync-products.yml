name: Sync Products Schema to PMAgent

on:
  push:
    branches:
      - main
    paths:
      - 'products/**'
      - 'shared/index.yml'
      - 'shared/data_hygiene.yml'
      - 'evaluation/**'
  workflow_dispatch:
    inputs:
      enable_auto_merge:
        description: 'Enable auto-merge on created PR'
        required: false
        default: 'false'
        type: boolean

env:
  AUTO_MERGE_ENABLED: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.enable_auto_merge == 'true' || 'false' }}

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # Checkout repo PMAgent-onboarding
      - name: Checkout Repo PMAgent-onboarding
        uses: actions/checkout@v4

      # Checkout target repo PMAgent
      - name: Checkout Repo PMAgent
        uses: actions/checkout@v4
        with:
          repository: Azure/PMAgent
          path: target
          token: ${{ secrets.INTPR_PAT }}

      # Copy files (overwrite changed, remove deleted)
      - name: Copy files to repo PMAgent
        run: |
          set -euo pipefail

          # products -> autogen/prompts/data_insights_ext
          mkdir -p target/autogen/prompts/data_insights_ext
          if [ -d "products" ] && [ "$(ls -A products)" ]; then
            rsync -a --delete products/ target/autogen/prompts/data_insights_ext/
          fi
          
          # shared/index.yml -> autogen/prompts/data_insights_ext
          if [ -f "shared/index.yml" ]; then
            rsync -a shared/index.yml target/autogen/prompts/data_insights_ext/
          fi
          
          # shared/data_hygiene.yml -> autogen/prompts/insights_writer_agent
          mkdir -p target/autogen/prompts/insights_writer_agent
          if [ -f "shared/data_hygiene.yml" ]; then
            rsync -a shared/data_hygiene.yml target/autogen/prompts/insights_writer_agent/
          fi

          # evaluation -> target/evaluation
          if [ -d "evaluation" ] && [ "$(ls -A evaluation)" ]; then
            rsync -a --delete evaluation/ target/evaluation/
          fi

      # Commit and push changes
      - name: Commit changes
        run: |
          cd target
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit"
            echo "NO_CHANGES=true" >> $GITHUB_ENV
            exit 0
          fi

          git fetch origin
          git checkout -B sync-from-onboarding
          git add .
          git commit -m "Sync updates from onboarding repo"
          git push origin sync-from-onboarding --force-with-lease

      # Create PR (only if there were changes)
      - name: Create Pull Request
        if: env.NO_CHANGES != 'true'
        run: |
          cd target
          gh auth status || gh auth login --with-token <<< "${GITHUB_TOKEN}"

          # Check if PR already exists
          existing_pr=$(gh pr list --head sync-from-onboarding --base dev --json number --jq '.[0].number' 2>/dev/null || echo "null")
          
          if [ "$existing_pr" != "null" ] && [ -n "$existing_pr" ]; then
            echo "PR already exists: #$existing_pr"
            if [ "$AUTO_MERGE_ENABLED" = "true" ] ; then
              gh pr merge "$existing_pr" --auto --squash
              echo "Auto-merge enabled on existing PR #$existing_pr"
            fi
          else
            echo "Creating new PR..."
            pr_url=$(gh pr create \
              --title "Sync updates from onboarding repo" \
              --body "Automated PR to sync files from onboarding repo" \
              --head sync-from-onboarding \
              --base dev)
            pr_number=$(echo "$pr_url" | grep -o '[0-9]\+$' || true)
            echo "Created PR ${pr_number:+#$pr_number}"

            if [ "$AUTO_MERGE_ENABLED" = "true" ] && [ -n "${pr_number}" ]; then
              gh pr merge "$pr_number" --auto --squash
              echo "Auto-merge enabled on PR #$pr_number"
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.INTPR_PAT }}
